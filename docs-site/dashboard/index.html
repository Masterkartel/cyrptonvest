<!doctype html>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard — Cyrptonvest</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<style>
  body{font-family:system-ui,Inter,Arial,sans-serif;margin:0;background:#0b0f19;color:#e6edf3}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #11162b;background:#0f1629}
  main{max-width:1100px;margin:0 auto;padding:16px}
  .cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#0f1629;border:1px solid #1d2640;border-radius:14px;padding:16px}
  .addr{display:flex;align-items:center;gap:8px;word-break:break-all;background:#0b1224;border:1px solid #1d2640;padding:10px;border-radius:10px}
  button{font:inherit}
  .btn{padding:8px 12px;border-radius:999px;background:#f59e0b;color:#111827;border:0;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1d2640;padding:8px;text-align:left}
  @media(max-width:900px){.cards{grid-template-columns:1fr}}
</style>
<header>
  <div style="display:flex;gap:10px;align-items:center"><img src="/assets/logo.svg" width="24"> <strong>Cyrptonvest</strong></div>
  <div>
    <button class="btn" onclick="logout()">Log out</button>
  </div>
</header>
<main>
  <h2>Welcome</h2>
  <div id="email" style="color:#9aa4b2"></div>

  <div class="cards">
    <div class="card">
      <h3>Wallet</h3>
      <div>Balance: <strong id="bal">—</strong> <span id="cur"></span></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="openDeposit()">Deposit</button>
        <button class="btn" onclick="openWithdraw()">Withdraw</button>
      </div>
      <div id="deposit" style="display:none;margin-top:10px">
        <p class="mini">Use your assigned addresses. After sending, click "I sent funds" and paste TXID.</p>
        <div class="addr"><small>BTC</small> <code id="btc"></code></div>
        <div class="addr"><small>USDT-TRC20</small> <code id="trc"></code></div>
        <div class="addr"><small>ETH (ERC20)</small> <code id="eth"></code></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <input id="txid" placeholder="Paste TXID / reference" style="flex:1;padding:8px;border-radius:8px;border:1px solid #1d2640;background:#0b1224;color:#e6edf3"/>
          <button class="btn" onclick="confirmDeposit()">I sent funds</button>
        </div>
      </div>
      <div id="withdraw" style="display:none;margin-top:10px">
        <div style="display:flex;gap:6px;margin-top:8px">
          <input id="amount" type="number" min="1" placeholder="Amount (USD cents)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #1d2640;background:#0b1224;color:#e6edf3"/>
          <input id="waddr" placeholder="Destination address" style="flex:1;padding:8px;border-radius:8px;border:1px solid #1d2640;background:#0b1224;color:#e6edf3"/>
          <button class="btn" onclick="requestWithdraw()">Request</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Plans</h3>
      <div id="plans">Loading…</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Transactions</h3>
    <table>
      <thead><tr><th>Time</th><th>Type</th><th>Amount</th><th>Status</th><th>Ref</th></tr></thead>
      <tbody id="txs"><tr><td colspan="5">Loading…</td></tr></tbody>
    </table>
  </div>
</main>
<script>
async function api(path,opts){ const r=await fetch(path,{credentials:'include',...opts}); if(r.status===401){ location.href='/login.html'; return; } return r.json(); }
async function boot(){
  const me = await api('/api/me');
  document.getElementById('email').textContent = me.user.email;
  const w = await api('/api/wallet/balance');
  document.getElementById('bal').textContent = (w.wallet.balance_cents/100).toFixed(2);
  document.getElementById('cur').textContent = w.wallet.currency;
  document.getElementById('btc').textContent = w.wallet.btc_addr;
  document.getElementById('trc').textContent = w.wallet.trc20_addr;
  document.getElementById('eth').textContent = w.wallet.eth_addr;
  const ps = await api('/api/plans/list');
  document.getElementById('plans').innerHTML = ps.plans.map(p=>`<div style="border:1px solid #1d2640;border-radius:10px;padding:10px;margin:8px 0"><strong>${p.name}</strong><div>Min: $${(p.min_deposit_cents/100).toFixed(2)}</div><button class='btn' onclick="subscribe('${p.id}')">Subscribe</button></div>`).join('');
  const txs = await api('/api/transactions');
  document.getElementById('txs').innerHTML = txs.transactions.map(t=>`<tr><td>${new Date(t.created_at).toLocaleString()}</td><td>${t.kind}</td><td>$${(t.amount_cents/100).toFixed(2)} ${t.currency}</td><td>${t.status}</td><td>${t.ref||''}</td></tr>`).join('') || '<tr><td colspan=5>No transactions yet</td></tr>';
}
function openDeposit(){ document.getElementById('withdraw').style.display='none'; document.getElementById('deposit').style.display='block'; }
function openWithdraw(){ document.getElementById('deposit').style.display='none'; document.getElementById('withdraw').style.display='block'; }
async function confirmDeposit(){ const txid=document.getElementById('txid').value.trim(); if(!txid) return alert('Enter TXID'); const r=await api('/api/wallet/deposit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount_cents:100, currency:'USD', network:'manual', address:'dashboard', txid})}); if(r?.ok){ alert('Recorded. We will confirm soon.'); location.reload(); } }
async function requestWithdraw(){ const amount=parseInt(document.getElementById('amount').value,10); const address=document.getElementById('waddr').value.trim(); if(!amount||!address) return alert('Fill amount and address'); const r=await api('/api/wallet/withdraw',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount_cents:amount,currency:'USD',network:'manual',address})}); if(r?.ok){ alert('Withdrawal requested.'); location.reload(); } }
async function subscribe(id){ const r=await api('/api/plans/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan_id:id})}); if(r?.ok){ alert('Subscribed!'); } }
async function logout(){ await fetch('/api/auth/logout',{method:'POST'}); location.href='/'; }
boot();
</script>
